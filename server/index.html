<html>
  <head>
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/application.css">
  </head>
  <body>
    <div class="gibier">
      <div class="background">
        <div class="background-filter">
          <div class="slide-control">
            <div class="page-back"></div>
            <div class="page-foward"></div>
            <div class="slide" />
          </div>
        </div>
      </div>
    </div>
    <script type="module">
      import { DefaultRubyVM } from "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@2.7.1/dist/browser/+esm";
      const response = await fetch("/dist/app.wasm");
      const module = await WebAssembly.compileStreaming(response);
      const { vm } = await DefaultRubyVM(module);

      const SLIDE_WIDTH = 1920;
      const SLIDE_HEIGHT = 1080;

      const zoom = (window.height / window.width < SLIDE_HEIGHT / SLIDE_WIDTH) ?
        window.innerHeight / SLIDE_HEIGHT :
        window.innerWidth / SLIDE_WIDTH;

      const top = (window.height / zoom - SLIDE_HEIGHT) / 2;
      const left = (window.width / zoom - SLIDE_WIDTH) / 2;

      document.addEventListener('keydown', function(e) {
        let keyCode = e.keyCode;
        vm.evalAsync(`
          pages = Pages.pages
          slide = JS.global[:document].getElementsByClassName('slide')[0]
          case ${keyCode}
          when 39
            page = pages.next.await
            slide[:innerHTML] = page.to_html.await
          when 37
            page = pages.prev.await
            slide[:innerHTML] = page.to_html.await
          end

          page_el = JS.global[:document].getElementsByClassName('page')[0]
          page_el[:style][:width] = '${SLIDE_WIDTH}px'
          page_el[:style][:height] = '${SLIDE_HEIGHT}px'
          page_el[:style][:top] = '${top}px'
          page_el[:style][:left] = '${left}px'
          page_el[:style][:zoom] = '${zoom}'
        `);
      });

      vm.evalAsync(`
        require 'js'
        require 'wasm_drb'

        class Pages
          def self.pages
            @pages ||= DRb::DRbObject.new_with_uri 'ws://127.0.0.1:9161'
          end
        end

        DRb.start_service("ws://127.0.0.1:9161/callback")
      `);
    </script>
  </body>
</html>

